name: Generate YouTube Videos

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 전체 히스토리 가져오기
          lfs: true       # Git LFS 파일도 가져오기
      
      - name: Checkout LFS objects
        run: git lfs checkout
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      # 디버깅: 폴더 구조 확인
      - name: Check reels folder
        run: |
          echo "=== Checking reels folder ==="
          if [ -d "reels" ]; then
            ls -la reels/ | head -20
            echo "Total video files: $(ls reels/ | wc -l)"
            
            # 파일 형식 확인
            echo ""
            echo "=== File extensions ==="
            ls reels/ | sed 's/.*\.//' | sort | uniq -c
          else
            echo "❌ reels folder not found!"
          fi
      
      # 디버깅: 기존 메타데이터 확인
      - name: Check existing metadata
        run: |
          echo "=== Existing metadata ==="
          if [ -f metadata/videos-metadata.json ]; then
            echo "Videos metadata size: $(wc -c < metadata/videos-metadata.json) bytes"
            echo "Videos metadata entries: $(cat metadata/videos-metadata.json | grep -o '\"[0-9]\{6\}\"' | wc -l)"
            
            # 샘플 데이터 표시
            echo ""
            echo "=== Sample metadata (first 20 lines) ==="
            head -20 metadata/videos-metadata.json
          else
            echo "⚠️  No existing metadata found"
          fi
      
      - name: Update metadata template
        run: |
          echo "=== Running generate-youtube-metadata.js ==="
          node scripts/generate-youtube-metadata.js
      
      # 디버깅: 업데이트된 메타데이터 확인
      - name: Check updated metadata
        run: |
          echo "=== Updated metadata ==="
          if [ -f metadata/videos-metadata.json ]; then
            echo "Videos metadata size: $(wc -c < metadata/videos-metadata.json) bytes"
            echo "Videos metadata entries: $(cat metadata/videos-metadata.json | grep -o '\"[0-9]\{6\}\"' | wc -l)"
            
            # 크기가 너무 작으면 경고
            size=$(wc -c < metadata/videos-metadata.json)
            if [ $size -lt 50 ]; then
              echo "⚠️  WARNING: videos-metadata.json is too small ($size bytes)!"
              echo "This might indicate a problem. Showing content:"
              cat metadata/videos-metadata.json
            fi
          fi
      
      - name: Generate youtube-data.js
        run: |
          echo "=== Running generate-videos.js ==="
          node scripts/generate-videos.js
      
      # 디버깅: 생성된 파일 확인
      - name: Check generated files
        run: |
          echo "=== Generated files ==="
          if [ -f js/youtube-data.js ]; then
            echo "✅ youtube-data.js created"
            echo "File size: $(wc -c < js/youtube-data.js) bytes"
            echo "Video count: $(grep -o '\"id\": \"video-' js/youtube-data.js | wc -l)"
            
            # 샘플 데이터 표시
            echo ""
            echo "=== Sample data (first 30 lines) ==="
            head -30 js/youtube-data.js
          else
            echo "❌ youtube-data.js not created!"
          fi
      
      - name: Check for changes
        id: check_changes
        run: |
          git diff --name-only
          if git diff --quiet && git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "ℹ️  No changes detected"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "✅ Changes detected"
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          echo "=== Staging changes ==="
          git add metadata/videos-metadata.json
          git add js/youtube-data.js
          
          echo "=== Staged files ==="
          git diff --staged --name-only
          
          echo "=== Committing ==="
          git commit -m "Auto-update youtube-data.js and metadata [skip ci]"
          
          echo "=== Pushing ==="
          git push
      
      - name: Summary
        if: always()
        run: |
          echo "=== Workflow Summary ==="
          echo "Video files in reels/: $(ls reels/ 2>/dev/null | wc -l)"
          
          if [ -f metadata/videos-metadata.json ]; then
            echo "Videos metadata: $(wc -c < metadata/videos-metadata.json) bytes"
            echo "Metadata entries: $(cat metadata/videos-metadata.json | grep -o '\"[0-9]\{6\}\"' | wc -l)"
          fi
          
          if [ -f js/youtube-data.js ]; then
            echo "Generated videos: $(grep -o '\"id\": \"video-' js/youtube-data.js | wc -l)"
          fi
          
          echo ""
          echo "✨ Workflow completed!"
